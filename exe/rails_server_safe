#!/usr/bin/env sh

# Safe wrapper for Rails server that doesn't fail if server is already running
# This prevents Foreman from terminating all processes when server is already up

PIDFILE="${PIDFILE:-tmp/pids/server.pid}"
PORT="${PORT:-3000}"

# Check if PID file exists and process is running
if [ -f "$PIDFILE" ]; then
  PID=$(cat "$PIDFILE" 2>/dev/null)
  
  # Check if the process is actually running
  if [ -n "$PID" ] && kill -0 "$PID" 2>/dev/null; then
    # Check if it's listening on the expected port
    if lsof -ti:$PORT -sTCP:LISTEN | grep -q "^$PID$" 2>/dev/null; then
      echo "Server is already running (pid: $PID, port: $PORT)"
      echo "Keeping process alive for Foreman..."
      # Keep the process alive by waiting indefinitely
      while true; do
        if ! kill -0 "$PID" 2>/dev/null; then
          echo "Server process ended. Exiting."
          exit 0
        fi
        sleep 5
      done
    else
      # PID exists but not listening on port - stale PID file
      echo "Removing stale PID file (pid: $PID not listening on port $PORT)"
      rm -f "$PIDFILE"
    fi
  else
    # PID file exists but process is dead - stale PID file
    echo "Removing stale PID file (process $PID not running)"
    rm -f "$PIDFILE"
  fi
fi

# Check if something else is using the port
if lsof -ti:$PORT -sTCP:LISTEN >/dev/null 2>&1; then
  EXISTING_PID=$(lsof -ti:$PORT -sTCP:LISTEN | head -1)
  echo "Port $PORT is already in use by process $EXISTING_PID"
  echo "Server may already be running. Keeping process alive for Foreman..."
  # Keep the process alive by monitoring the existing server
  while true; do
    if ! lsof -ti:$PORT -sTCP:LISTEN >/dev/null 2>&1; then
      echo "Port $PORT is now free. Exiting so Foreman can restart."
      exit 0
    fi
    sleep 5
  done
fi

# Start the server normally
# Use exec to replace this process with rails server
exec bin/rails server "$@"
